<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>도서관리 시스템</title>
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community/dist/ag-grid-community.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        .modal {
            display: none;
            position: relative;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .modal h2 {
            margin: 0;
        }

        .modal button {
            display: inline-block;
            width: 100px;
            margin-left: calc(100% - 100px - 10px);
        }

        .modal .modal_content {
            width: 400px;
            margin: 100px auto;
            padding: 20px 10px;
            background: #fff;
            border: 2px solid #666;
        }

        .modal .modal_layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: -1;
        }
    </style>
</head>

<body>
	<div style="display: flex; justify-content: space-between;">
	    <button type="button" onclick="memberClick()">회원 가입</button>
	    <button type="button" id="insertBtn" onclick="insertClick()">도서 등록</button>
	</div>

    <div id="myGrid" style="height: 250px; width: auto;" class="ag-theme-alpine"></div>

	<!-- 대출 관리 모달 시작 -->
    <div class="modal" id="borrowModal">
        <div class="modal_content">
            <h2>대출 이력</h2>
            <input type="hidden" id="bookCode" value="">
            <div>
                <table border="1">
                    <thead>
                        <tr>
                            <td>대출코드</td>
                            <td>대출일자</td>
                            <td>반납일자</td>
                            <td>대출자 ID</td>
                        </tr>
                    </thead>
                    <tbody id="borrowList">
                    </tbody>
                </table>
            </div>
            <div>
            	<table border="1">
            		<tr>
            			<td>대출가능여부</td>
            			<td id="lastBorrowStatus"></td>
            		</tr>
            	</table>
            </div>
            <div id="inputId">
                <label for="memberId">대출자 ID :</label>
                <input type="text" id="memberId">
            </div>
            <div>
                <button type="button" id="borrowBtn" onclick="borrowClick()">대출</button>
                <button type="button" id="returnBtn" onclick="returnClick()">반납</button>
                <button type="button" onclick="closeModal()">닫기</button>
            </div>
        </div>
        <div class="modal_layer"></div>
    </div>
    <!-- 대출 관리 모달 끝 -->
	
	<!-- 도서 등록 모달 시작 -->
    <div class="modal" id="insertModal">
        <div class="modal_content">
            <h2>도서 등록</h2>
            <div>
                <table border="1">
                    <thead>
                        <tr>
                            <td>제목</td>
                            <td>저자</td>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                				<input type="text" id="title">
                            </td>
                            <td>
                				<input type="text" id="author">
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div>
                <button type="button" onclick="insertBook()">등록</button>
                <button type="button" onclick="closeModal()">닫기</button>
            </div>
        </div>
        <div class="modal_layer"></div>
    </div>
    <!-- 도서 등록 모달 끝 -->
    
	<!-- 도서 수정 모달 시작 -->
    <div class="modal" id="modifyModal">
        <div class="modal_content">
            <h2>도서 수정</h2>
            <div>
	            <input type="hidden" id="inputBookCode">
            </div>
            <div>
                <table border="1">
                    <thead>
                        <tr>
                            <td>제목</td>
                            <td>저자</td>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                				<input type="text" id="inputTitle">
                            </td>
                            <td>
                				<input type="text" id="inputAuthor">
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div>
                <button type="button" onclick="modifyBook()">수정</button>
                <button type="button" onclick="closeModal()">닫기</button>
            </div>
        </div>
        <div class="modal_layer"></div>
    </div>
    <!-- 도서 수정 모달 끝 -->
    
	<!-- 회원가입 모달 시작 -->
    <div class="modal" id="memberModal">
        <div class="modal_content">
            <h2>회원 가입</h2>
            <div>
                <table border="1">
                        <tr>
                            <td>회원 ID</td>
                            <td>
                				<input type="text" id="checkId">
	                            <button type="button" id="checkBtn" onclick="checkId()">중복 확인</button>
                            </td>
                        </tr>
                        <tr>
                            <td>이름</td>
                            <td>
                				<input type="text" id="inputName">
                            </td>
						</tr>
						<tr>
                            <td>전화번호</td>
                            <td>
                				<input type="text" id="inputPhone1" maxlength="3">-
		                        <input type="text" id="inputPhone2" maxlength="4">-
		                        <input type="text" id="inputPhone3" maxlength="4">
                        	</td>
                        </tr>
                </table>
            </div>
            <div>
                <button type="button" onclick="joinMember()">가입</button>
                <button type="button" onclick="closeModal()">닫기</button>
            </div>
        </div>
        <div class="modal_layer"></div>
    </div>
    <!-- 회원가입 모달 끝 -->

    <script>
        const columnDefs = [
            {
                headerName: "대출 관리",
                cellRenderer: function (params) {
                    return `<button onclick="manageClick('${params.data.bookCode}')">관리</button>`;
                },
                cellStyle: { textAlign: "left" },
            },
            { field: "bookCode", headerName: "도서코드", sortable: true },
            { field: "title", headerName: "제목", sortable: true, cellStyle: { textAlign: "left" } },
            { field: "author", headerName: "저자", cellStyle: { textAlign: "left" } },
            {
                headerName: "도서 수정",
                cellRenderer: function (params) {
                    return `<button onclick="modifyClick(this)">수정</button>`;
                },
                cellStyle: { textAlign: "left" },
            },
        ];

        const rowData = [];

        const gridOptions = {
            columnDefs: columnDefs,
            rowData: rowData,
            defaultColDef: {
                flex: 1,
                filter: true,
                resizable: true,
                minWidth: 100,
                headerClass: "centered",
            },
            pagination: true,
            paginationPageSize: 5,
            paginationPageSizeSelector: [5, 10, 20],
        };
        
        let gridApi;

        $(function() {
        	const gridDiv = document.querySelector('#myGrid');
            gridApi = agGrid.createGrid(gridDiv, gridOptions);
            getData();
        });

        // 도서 목록
        function getData() {
            $.ajax({
                url: "/api/books",
                method: "GET",
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    console.log('데이터', data);
                    gridApi.setRowData(data);
                },
                error: function (xhr, status, error) {
                    console.error('상태', status);
                },
            });
        };

        // 관리 버튼
        function manageClick(bookCode) {
            $.ajax({
                url: `/api/borrow/${bookCode}`,
                method: "GET",
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    console.log('데이터', data);

                    let borrowListHTML = '';
                    let lastBorrowStatus = '';
                    
                    $("#bookCode").val(bookCode);

                    data.forEach(borrowVO => {
                        const borrowDate = new Date(borrowVO.borrowDate);
                        const formattedBorrowDate = borrowDate.toISOString().split('T')[0];

                        let formattedReturnDate = "";

                        if (borrowVO.returnDate != null) {
                            const returnDate = new Date(borrowVO.returnDate);
                            formattedReturnDate = returnDate.toISOString().split('T')[0];
                        }

                        borrowListHTML += `
                            <tr>
                                <td class="borrowCode">${borrowVO.borrowCode}</td>
                                <td>${formattedBorrowDate}</td>
                                <td>${formattedReturnDate}</td>
                                <td>${borrowVO.memberId}</td>
                            </tr>`;

                        lastBorrowStatus = borrowVO.borrowStatus;
                    });
                    
                    $("#borrowList").html(borrowListHTML);
                    $("#lastBorrowStatus").html(lastBorrowStatus);

                    const borrowBtn = $("#borrowBtn");
                    const returnBtn = $("#returnBtn");
                    const inputId = $("#inputId");

                    if (lastBorrowStatus == 'N') {
                        inputId.css('display', 'none');
                        borrowBtn.css('display', 'none');
                        returnBtn.css('display', 'block');
                    } else {
                        inputId.css('display', 'block');
                        borrowBtn.css('display', 'block');
                        returnBtn.css('display', 'none');
                    }

                },
                error: function (xhr, status, error) {
                    console.error('상태', status);
                },
            });

            $("#borrowModal").css("display", "block");
        };

        // 모달 닫기 버튼
        function closeModal() {
            $(".modal").css("display", "none");
        };
        
        // 대출 버튼
        function borrowClick(){
        	const memberId = $("#memberId").val();
       	    if (!memberId) {
       	    	alert("아이디를 입력해주세요.");
				return;
		     }
       	    
        	let bookCode = $("#bookCode").val();
        	
        	let borrowVO = JSON.stringify({
        		bookCode : bookCode,
        		memberId : memberId
    		});
        	
        	console.log("borrowVO",borrowVO);
        	
        	$.ajax({
                url: "/api/borrow",
                method: "post",
                data: borrowVO,
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                      console.log('데이터', data);
                      alert("대출 처리되었습니다.");
                      manageClick(bookCode);
                  },
                  error: function (xhr, status, error) {
                      console.error('상태', status);
                  },
              });
        }
        
        // 반납 버튼
        function returnClick(){
        	let bookCode = $("#bookCode").val();
        	let lastBorrowCode = $(".borrowCode:last").text();
        	
        	let borrowVO = JSON.stringify({
        		borrowCode : lastBorrowCode
    		});
        	
        	$.ajax({
                url: "/api/borrow",
                method: "put",
                data: borrowVO,
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                      console.log('데이터', data);
                      alert("반납 처리되었습니다.");
                      manageClick(bookCode);
                  },
                  error: function (xhr, status, error) {
                      console.error('상태', status);
                  },
              });
        }

        // 도서 등록 모달
        function insertClick(){
        	$("#title").val("");
        	$("#author").val("");
        	$("#insertModal").css("display", "block");
        }
        
        // 도서 등록하기
        function insertBook(){
        	let title = $("#title").val();
        	let author = $("#author").val();
        	
        	if (!title || !author) {
       	    	alert("제목과 저자를 모두 입력해주세요.");
				return;
		     }
        	
        	let bookVO = JSON.stringify({
        		title : title,
        		author : author
    		});
        	console.log("bookVO",bookVO);
        	
        	 $.ajax({
                 url: `/api/book`,
                 method: "post",
                 data: bookVO,
                 contentType: "application/json; charset=utf-8",
                 success: function (data) {
                     console.log('데이터', data);
                     getData();
                     $(".modal").css("display", "none");
                     alert("등록 처리되었습니다.");
                 },
                 error: function (xhr, status, error) {
                     console.error('상태', status);
                 },
             });
        }
        
        // 도서 수정 모달
        function modifyClick(button){
        	const parentRow = button.parentNode.parentNode.parentNode;
            console.log("parentRow",parentRow);
        	
        	const bookCode = parentRow.querySelector('[col-id="bookCode"]').textContent;
            const title = parentRow.querySelector('[col-id="title"]').textContent;
            const author = parentRow.querySelector('[col-id="author"]').textContent;
            console.log(bookCode, title, author);
            
            $("#inputBookCode").val(bookCode);
            $("#inputTitle").val(title);
            $("#inputAuthor").val(author);
            
        	$("#modifyModal").css("display", "block");
        }
        
     	// 도서 수정하기	
        function modifyBook(){
        	let bookCode = $("#inputBookCode").val();
        	let title = $("#inputTitle").val();
        	let author = $("#inputAuthor").val();
        	
        	let bookVO = JSON.stringify({
        		bookCode : bookCode,
        		title : title,
        		author : author
    		});
        	
        	$.ajax({
                url: "/api/book",
                method: "put",
                data: bookVO,
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                      console.log('데이터', data);
                      getData();
                      $(".modal").css("display", "none");
                      alert("수정 처리되었습니다.");
                  },
                  error: function (xhr, status, error) {
                      console.error('상태', status);
                  },
              });
        }
     	
     	// 회원가입 버튼
        function memberClick(){
        	$("#checkId").prop("readonly", false);
       		$("#checkBtn").prop("disabled", false);
        	$("#checkId").val("");
        	$("#inputName").val("");
        	$("#inputPhone1").val("");
        	$("#inputPhone2").val("");
        	$("#inputPhone3").val("");
        	
        	$("#memberModal").css("display", "block");
        }
     	
     	// 회원 가입하기
        function joinMember(){
        	let memberId = $("#checkId").val();
        	let name = $("#inputName").val();
        	let phoneNumber1 = $("#inputPhone1").val();
        	let phoneNumber2 = $("#inputPhone2").val();
        	let phoneNumber3 = $("#inputPhone3").val();
        	
        	if (!memberId || !name || !phoneNumber1 || !phoneNumber2 || !phoneNumber3) {
       	    	alert("모두 입력해주세요.");
				return;
		     }

        	if (!$('#checkBtn').prop('disabled')) {
       	    	alert("ID 중복 확인해주세요.");
				return;
		     }

        	const phoneRegex = /^\d{3}-\d{4}-\d{4}$/;
            if (!phoneRegex.test(`${phoneNumber1}-${phoneNumber2}-${phoneNumber3}`)) {
                alert("올바른 전화번호 형식이 아닙니다. 숫자만 입력해주세요.");
                return;
            }
        	
        	let phoneNumber = phoneNumber1 + "-" + phoneNumber2 + "-" + phoneNumber3
        	
        	let memberVO = JSON.stringify({
        		memberId : memberId,
        		name : name,
        		phoneNumber : phoneNumber
    		});
        	console.log("memberVO",memberVO);
        	
        	 $.ajax({
                 url: `/api/member`,
                 method: "post",
                 data: memberVO,
                 contentType: "application/json; charset=utf-8",
                 success: function (data) {
                     console.log('데이터', data);
                     $(".modal").css("display", "none");
                     alert("가입 처리되었습니다.");
                 },
                 error: function (xhr, status, error) {
                     console.error('상태', status);
                 },
             });
        }
     	
     	// 중복 확인 버튼
        function checkId(){
        	var memberId = $("#checkId").val();
        	console.log("checkId 입력값:", memberId);
        	
        	 $.ajax({
                 url: "/api/member",
                 method: "get",
                 data: {memberId: memberId},
                 contentType: "application/json; charset=utf-8",
                 success: function (data) {
                     console.log('데이터', data);
                     if(data!=0){
                    	 alert("사용할 수 없는 아이디입니다. 다른 아이디를 입력해 주세요.");
                     }else{
                    	 alert("사용 가능한 아이디입니다.");
                    	 $("#checkId").prop("readonly", true);
                    	 $("#checkBtn").prop("disabled", true);
                     }
                 },
                 error: function (xhr, status, error) {
                     console.error('상태', status);
                 },
             });
     	}

    </script>
</body>

</html>